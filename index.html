<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width"/>
<title>üçå</title>
<link rel="manifest" href="/manifest.json"/>
<style>
  @import url('https://rsms.me/inter/inter.css');

  :root {
    --color-background: #010101;
    --color-text: #fff;
  }

  * {
    box-sizing: border-box;
  }

  ::selection {
    background-color: var(--color-text);
    color: var(--color-background);
  }

  a {
    color: inherit;
    text-decoration: none;
  }

  body {
    background: var(--color-background);
    font-family: 'Inter', sans-serif;
    color: var(--color-text);
    width: 100%;
    height: 100%;
    margin: 0;
  }

  .panel {
    max-width: 50em;
  }

  .panel,
  .menu {
    padding: 2em;
  }

  h1 {
    cursor: pointer;
  }

  .menu__feed {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .menu__feed .feed {
    padding: .75em 0;
    display: block;
  }

  .card {
    margin: 0 0 5em;
  }

  .card__title {
    font-size: 1.8em;
    letter-spacing: -0.055em;
    line-height: 0.9em;
    text-indent: -0.03em;
    font-weight: 700;
    line-height: 1.25em;
  }

  .card__image {
    width: 100%;
    border-radius: .5em;
    filter: saturate(75%);
  }

  .card__source {
    font-weight: 350;
  }

  .card__description {
    line-height: 1.7em;
    overflow: hidden;
  }

  .feed__icon {
    width: 16px;
    height: 16px;
    border-radius: 2px;
  }

  .categ__button {
    display: block;
    padding: .75em 0;
  }

  .categ__feeds {
    display: none;
    padding-left: 1em;
  }

  .categ__input:checked ~ .categ__feeds {
    display: block;
  }

  .btn--more {
    border: 1px solid var(--color-text);
    background: transparent;
    color: var(--color-text);
    font-size: 1.5em;
    width: 100%;
    padding: .5em 5em;
    display: block;
  }

  .btn--more:hover {
    background: var(--color-text);
    color: var(--color-background);
  }

  .btn--menu {
    --size: 55px;
    background: var(--color-text);
    color: var(--color-background);
    font-size: 1.5em;
    position: fixed;
    bottom: var(--size);
    right: 2rem;
    width: var(--size);
    height: var(--size);
    z-index: 99;
    border: none;
    border-radius: 100%;
    line-height: 1em;
    cursor: pointer;
  }

  .btn--more:hover {
    background: var(--color-text);
    color: var(--color-background);
  }

  .slideout-menu {
    position: fixed;
    top: 0;
    bottom: 0;
    width: 256px;
    min-height: 100vh;
    overflow-y: scroll;
    -webkit-overflow-scrolling: touch;
    z-index: 0;
    display: none;
  }

  .slideout-menu-left {
    left: 0;
  }

  .slideout-menu-right {
    right: 0;
  }

  .slideout-panel {
    position: relative;
    z-index: 1;
    will-change: transform;
    background: var(--color-background);
    min-height: 100vh;
  }

  .slideout-open,
  .slideout-open body,
  .slideout-open .slideout-panel {
    overflow: hidden;
  }

  .slideout-open .slideout-menu {
    display: block;
  }

  @media (min-width: 50em) {
    .menu,
    .panel {
      padding: 3em;
    }

    .card__title {
      font-size: 2em;
    }

    .btn--more {
      margin: 0 auto;
      width: auto;
      cursor: pointer;
    }

    .slideout-menu {
      width: 20em;
    }

    .slideout-panel {
      margin-left: 20em;
    }

    .slideout-menu {
      display: block;
    }
  }

  @supports (font-variation-settings: normal) {
    body { font-family: 'Inter var', sans-serif; }
  }
</style>

<nav class="menu"><h1>&#8635;</h1></nav>
<main class="panel"></main>
<button class="btn btn--menu">&#9776;</button>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
<script type="module">
import { feedList, feedCategs } from './feeds.js';

const menu = document.querySelector('.menu');
const panel = document.querySelector('.panel');

// PANEL /////////////////////////////////////////

let page = 1;
const today = new Date();

function fetchAndRender(config = {}) {
  panel.innerHTML = '<h2 class="card__title">Loading...</h2>';
  fetch([
    '/api/feeds',
    '?offset=25',
    `&page=${page}`,
    config.feed ? `&feed=${config.feed}` : '',
    config.ids ? `&ids=${config.ids}` : '',
  ].join(''))
    .then(res => res.json())
    .then(items => items.map(Item).join(''))
    .then(content => panel.innerHTML = `${content}${!config.feeds && !config.ids ? More() : ''}`);
}
fetchAndRender();

function formatDate(date) {
  const d = new Date(date);
  const isFromToday = d.getDay() === today.getDay();
  return d.toLocaleTimeString([], {
    dateStyle: !isFromToday ? 'medium' : undefined,
    timeStyle: isFromToday ? 'short' : undefined,
  });
}

function More() {
  return `<button class="btn btn--more">More</button>`;
}

function Item({ link, title, feed, date, image, description }) {
  return `
    <article class="card">
      <h2 class="card__title">
        <a class="card__link" href=${link} target="_blank">${title}</a>
      </h2>
      <h3 class="card__source">
        ${Feed({
          name: Object.keys(feedList)[feed],
          ...Object.values(feedList)[feed]
        })}
        &middot; <time>${formatDate(date)}</time>
      </h3>
      ${image ? `
        <a href=${link} target="_blank">
          <img class="card__image" src="${image}" loading="lazy"/>
        </a>` : ''
      }
      <p class="card__description">${description}</p>
    </article>
  `;
}

// MENU //////////////////////////////////////////

const slideout = new Slideout({ panel, menu, padding: 256, tolerance: 70, touch: false });
document.querySelector('.btn--menu').addEventListener('click', () => slideout.toggle());

function Categ({ name }) {
  return `
    <section class="categ">
      <input class="categ__input" type="checkbox" id="${name}" hidden/>
      <label class="categ__button" for="${name}">${name}</label>
      <div class="categ__feeds">
        ${Object.keys(feedList)
          .filter((x, i) => feedCategs[name].feeds.includes(i))
          .sort()
          .map(feedName => `
            <div class="menu__feed">
              ${Feed({ name: feedName, ...feedList[feedName] })}
            </div>
          `).join('')
        }
      </div>
    </section>
  `;
}

menu.insertAdjacentHTML('beforeEnd', Object.keys(feedCategs).map(name => Categ({ name })).join(''));

document.querySelector('h1').addEventListener('click', () => {
  slideout.close();
  fetchAndRender();
});

// FEEDS /////////////////////////////////////////

document.body.addEventListener('click', (ev) => {
  if (ev.target.classList.contains('feed')) {
    ev.preventDefault();
    slideout.close();
    const feed = ev.target.textContent.trim();
    fetchAndRender({ feed });
  } else if (ev.target.classList.contains('btn--more')) {
    page++;
    fetchAndRender();
  } else if (ev.target.classList.contains('categ__button')) {
    const categName = ev.target.textContent.trim();
    if (!document.getElementById(categName).checked) {
      const ids = feedCategs[categName].feeds;
      fetchAndRender({ ids });
    }
  }
});

function Feed({ domain, altFavicon, name }) {
  return `
    <a class="feed" href=${domain} target="_blank">
      <img
        src="${!altFavicon ? `${domain}/favicon.ico` : altFavicon}"
        class="feed__icon"
        loading="lazy"
      />
      ${name}
    </a>
  `;
}

</script>
